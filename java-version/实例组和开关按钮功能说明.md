# 实例组和开关按钮功能实现说明

## 🎯 功能概述

已成功实现两个重要功能：
1. **实例组功能** - 一个实例按钮控制多个指令的组合执行
2. **开关按钮功能** - 具有开/关两种状态的智能按钮

---

## 📋 1. 实例组功能

### 功能描述
实例组是一个实例按钮，用来控制其他多个实例的指令。点击实例组后，会按顺序执行所有选中的指令。

### 使用方法

#### 1.1 配置实例组
1. **选择功能类型**：在属性面板中选择"实例组"
2. **点击编辑按钮**：在"指令："后面点击"编辑"按钮
3. **配置指令名称**：输入实例组的名称
4. **选择指令**：
   - 勾选框显示所有已设置的指令和其他实例组
   - 支持全选功能
   - 可以选择多个指令组合执行
5. **保存配置**：点击"确定"保存配置

#### 1.2 执行实例组
- 在主界面点击配置了实例组的实例
- 系统会按顺序执行所有选中的指令
- 每条指令间隔100ms执行，避免网络拥塞
- 支持递归执行（实例组可以包含其他实例组）

### 技术特性
- ✅ **智能指令收集**：自动扫描所有页面中的指令和实例组
- ✅ **去重处理**：避免重复显示相同名称的指令
- ✅ **错误处理**：单条指令失败不影响后续指令执行
- ✅ **执行统计**：显示成功/失败指令数量
- ✅ **详细日志**：完整的执行过程日志输出

### 控制台输出示例
```
=== 开始执行实例组: 照明控制, 包含 3 条指令 ===
执行第 1 条指令: 客厅灯开
  → 找到指令: 客厅灯开
  ✓ TCP数据发送完成，已发送 12 字节
✓ 第 1 条指令执行成功
执行第 2 条指令: 卧室灯开
  → 找到指令: 卧室灯开
  ✓ TCP数据发送完成，已发送 12 字节
✓ 第 2 条指令执行成功
=== 实例组执行完成，成功: 3 条，失败: 0 条 ===
```

---

## 🔘 2. 开关按钮功能

### 功能描述
开关按钮是一种特殊的实例，具有开/关两种状态，每种状态对应不同的UI样式和网络指令。

### 判定规则
当实例的样式路径位于 `USERDATA/appearance/button/` 目录下时，自动判定为开关按钮。

### 文件夹结构要求
```
USERDATA/appearance/button/
├── button1/
│   ├── btn1.png  (关状态样式)
│   └── btn2.png  (开状态样式)
├── button2/
│   ├── btn1.png
│   └── btn2.png
└── ...
```

### 使用方法

#### 2.1 创建开关按钮
1. **选择样式**：选择位于 `appearance/button/buttonX/` 目录下的图片
2. **系统自动识别**：系统会自动检测并将其标识为开关按钮
3. **初始状态**：默认显示关状态（btn1.png）

#### 2.2 配置开关按钮
1. **编辑模式**：在编辑模式下双击开关按钮
2. **配置对话框**：打开"开关按钮配置"对话框
3. **设置指令**：
   - **关状态指令**：当按钮处于关状态时点击发送的指令
   - **开状态指令**：当按钮处于开状态时点击发送的指令
   - 指令格式：`指令名称|协议类型|IP地址|端口|十六进制内容`
4. **保存配置**：点击"确定"保存配置

#### 2.3 使用开关按钮
- **主界面点击**：点击开关按钮切换状态
- **状态切换逻辑**：
  - 关状态 → 点击 → 发送开指令 → 切换为开状态
  - 开状态 → 点击 → 发送关指令 → 切换为关状态
- **UI更新**：状态切换后立即更新显示样式

### 数据结构
```java
class SwitchButtonData {
    String id;              // 唯一标识
    String displayName;     // 显示名称
    String offImagePath;    // 关状态图片路径
    String onImagePath;     // 开状态图片路径
    String offCommand;      // 关状态指令
    String onCommand;       // 开状态指令
    boolean currentState;   // 当前状态 (true=开, false=关)
}
```

### 技术特性
- ✅ **自动检测**：基于文件路径自动识别开关按钮
- ✅ **状态管理**：完整的开/关状态管理
- ✅ **UI同步**：状态变化时自动更新界面显示
- ✅ **网络集成**：与现有网络指令发送功能完全集成
- ✅ **错误处理**：指令发送失败时状态不变
- ✅ **默认样式**：图片加载失败时使用文字显示

### 控制台输出示例
```
执行开关按钮
当前状态: 关
发送指令: 灯光开启|TCP|127.0.0.1|8080|01 05 00 01 FF 00
→ 发送指令: 灯光开启 [TCP 127.0.0.1:8080] 数据长度: 6 字节
  ✓ TCP数据发送完成，已发送 6 字节
✓ 开关按钮图片已更新: USERDATA/appearance/button/button1/btn2.png
✓ 开关按钮状态已切换为: 开
```

---

## 🔧 集成说明

### 与现有系统的集成
1. **网络指令发送**：完全复用现有的TCP/UDP网络发送功能
2. **数据持久化**：集成到现有的project_data.json保存机制
3. **UI框架**：基于现有的Swing界面框架
4. **属性面板**：与现有的实例属性管理系统集成

### 兼容性
- ✅ **向后兼容**：支持旧格式指令数据的加载和转换
- ✅ **混合使用**：实例组可以包含普通指令和其他实例组
- ✅ **错误恢复**：各种异常情况的优雅处理

---

## 📝 使用建议

### 实例组最佳实践
1. **合理分组**：将相关的指令组合成实例组
2. **避免循环**：不要让实例组包含自己
3. **测试验证**：配置完成后测试所有指令是否正常执行

### 开关按钮最佳实践
1. **图片准备**：确保btn1.png和btn2.png文件存在且清晰
2. **指令测试**：配置完成后测试开关指令是否正确
3. **状态同步**：确保设备实际状态与按钮显示状态一致

---

## 🔧 问题修复：开关按钮强制校验

### 问题描述
用户反馈：使用USERDATA/appearance/button路径下的样式时，指令列表只建立一个命令后点击确定没有触发校验（强制添加两条指令）。

### 修复方案

#### 1. **自动检测开关按钮**
- 在`openCommandListDialog`方法中添加开关按钮检测逻辑
- 当检测到开关按钮时，自动跳转到专用的开关按钮编辑对话框
- 避免用户进入普通的指令列表管理界面

#### 2. **强制校验逻辑**
在开关按钮编辑对话框中添加严格的校验：

```java
// 校验：开关按钮必须配置两条指令
if (offCommand.isEmpty()) {
    JOptionPane.showMessageDialog(dialog, "请配置关状态指令", "校验失败", JOptionPane.WARNING_MESSAGE);
    return;
}

if (onCommand.isEmpty()) {
    JOptionPane.showMessageDialog(dialog, "请配置开状态指令", "校验失败", JOptionPane.WARNING_MESSAGE);
    return;
}

// 校验指令格式（应该包含5个部分：名称|协议|IP|端口|指令内容）
String[] offParts = offCommand.split("\\|");
String[] onParts = onCommand.split("\\|");

if (offParts.length < 5) {
    JOptionPane.showMessageDialog(dialog,
        "关状态指令格式错误，应为：指令名称|协议类型|IP地址|端口|指令内容",
        "校验失败", JOptionPane.WARNING_MESSAGE);
    return;
}
```

#### 3. **完善的指令编辑功能**
- 为开关按钮的"编辑"按钮实现了完整的指令编辑对话框
- 支持协议类型选择（TCP/UDP）
- 支持指令名称、IP地址、端口、指令内容的独立编辑
- 包含完整的输入校验

#### 4. **数据兼容性**
- 开关按钮数据同时保存到`switchButtonData`和`commands`属性
- 确保与现有系统的完全兼容
- 支持新旧数据格式的无缝转换

### 修复效果

#### 修复前：
- 用户可以在开关按钮中只配置一条指令
- 没有强制校验，可能导致功能不完整
- 编辑按钮功能不完善

#### 修复后：
- ✅ **自动识别**：检测到开关按钮自动打开专用编辑界面
- ✅ **强制校验**：必须配置关状态和开状态两条指令
- ✅ **格式验证**：确保指令格式正确（5个部分完整）
- ✅ **完善编辑**：提供直观的指令编辑界面
- ✅ **错误提示**：清晰的错误提示信息

### 测试验证

#### 测试步骤：
1. 选择位于`USERDATA/appearance/button/`路径下的样式
2. 在属性面板中选择"发送指令"功能
3. 点击"编辑"按钮

#### 预期结果：
- 自动打开"开关按钮配置"对话框
- 必须配置两条指令才能保存
- 提供清晰的错误提示和格式要求

#### 错误提示示例：
```
校验失败：请配置关状态指令
校验失败：请配置开状态指令
校验失败：关状态指令格式错误，应为：指令名称|协议类型|IP地址|端口|指令内容
```

---

## 🎉 总结

两个功能已完全实现并集成到现有系统中：

1. **实例组功能**：提供了强大的指令组合执行能力
2. **开关按钮功能**：提供了直观的状态切换控制，包含完整的校验机制

### 最新修复：
- ✅ **开关按钮强制校验**：确保必须配置两条指令
- ✅ **自动检测机制**：基于文件路径自动识别开关按钮
- ✅ **完善的编辑界面**：提供专业的指令编辑功能
- ✅ **严格的格式验证**：确保指令格式正确性

这些功能大大增强了中控软件的实用性和用户体验，支持更复杂的设备控制场景，同时确保了配置的正确性和完整性。
