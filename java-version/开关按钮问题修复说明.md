# 开关按钮问题修复说明

## 🔍 问题分析

### 问题1：发送指令内容错误
**现象**：
- 保存的数据：`"00 01 00 00 00 06 01 06 00 01 00 01"`（完整的十六进制指令）
- 实际发送：`01`（只有1字节）

**原因**：
在 `getSwitchButtonData` 方法中，使用了硬编码的默认指令：
```java
switchData.setOffCommand("开启指令|TCP|127.0.0.1|8080|00");
switchData.setOnCommand("关闭指令|TCP|127.0.0.1|8080|01");
```

### 问题2：按钮样式没有更新
**现象**：
- 日志显示：`开关按钮图片已更新: USERDATA/appearance/button/button1/btn2.png`
- 实际界面：按钮样式没有变化

**原因**：
UI更新逻辑存在，但可能存在图片加载或刷新问题。

---

## 🔧 修复方案

### 修复1：正确加载指令数据

#### 修改前：
```java
// 设置默认指令（如果没有配置，使用空指令）
switchData.setOffCommand("开启指令|TCP|127.0.0.1|8080|00");
switchData.setOnCommand("关闭指令|TCP|127.0.0.1|8080|01");
```

#### 修改后：
```java
// 从commands属性中加载指令数据
Object commands = instance.getClientProperty("commands");
if (commands instanceof java.util.List) {
    @SuppressWarnings("unchecked")
    java.util.List<String> commandList = (java.util.List<String>) commands;
    
    // 如果有两条指令，分别设置为关状态和开状态指令
    if (commandList.size() >= 2) {
        switchData.setOffCommand(commandList.get(0)); // 第一条为关状态指令
        switchData.setOnCommand(commandList.get(1));  // 第二条为开状态指令
        System.out.println("从commands加载指令:");
        System.out.println("关状态指令: " + switchData.getOffCommand());
        System.out.println("开状态指令: " + switchData.getOnCommand());
    } else {
        // 设置默认指令
        switchData.setOffCommand("关状态指令|TCP|127.0.0.1|8080|00");
        switchData.setOnCommand("开状态指令|TCP|127.0.0.1|8080|01");
        System.out.println("使用默认指令配置");
    }
} else {
    // 设置默认指令
    switchData.setOffCommand("关状态指令|TCP|127.0.0.1|8080|00");
    switchData.setOnCommand("开状态指令|TCP|127.0.0.1|8080|01");
    System.out.println("commands属性为空，使用默认指令配置");
}
```

### 修复2：增强UI更新调试

#### 添加详细调试信息：
```java
private void updateSwitchButtonUI(JPanel instance, SwitchButtonData switchData) {
    try {
        // 获取当前应该显示的图片路径
        String currentImagePath = switchData.getCurrentImagePath();
        System.out.println("调试：当前状态=" + switchData.getCurrentState() + ", 应显示图片=" + currentImagePath);

        // 查找实例中的JLabel组件
        Component[] components = instance.getComponents();
        System.out.println("调试：实例中组件数量=" + components.length);
        for (Component comp : components) {
            if (comp instanceof JLabel) {
                JLabel label = (JLabel) comp;
                System.out.println("调试：找到JLabel组件，当前图标=" + (label.getIcon() != null ? "有图标" : "无图标"));
                // ... 图片更新逻辑
            }
        }
    } catch (Exception e) {
        System.out.println("✗ 更新开关按钮UI失败: " + e.getMessage());
    }
}
```

---

## 📊 数据流程分析

### 正确的数据流程：

1. **数据保存**（JSON格式）：
```json
"commands": [
  {
    "name": "开启指令",
    "protocol": "TCP", 
    "ip": "127.0.0.1",
    "port": "8080",
    "command": "00 01 00 00 00 06 01 06 00 01 00 01"
  },
  {
    "name": "关闭指令",
    "protocol": "TCP",
    "ip": "127.0.0.1", 
    "port": "8080",
    "command": "00 01 00 00 00 06 01 06 00 01 00 00"
  }
]
```

2. **数据加载**（转换为字符串格式）：
```java
String commandData = String.format("%s|%s|%s|%s|%s", name, protocol, ip, port, command);
// 结果：开启指令|TCP|127.0.0.1|8080|00 01 00 00 00 06 01 06 00 01 00 01
```

3. **开关按钮使用**：
```java
switchData.setOffCommand(commandList.get(0)); // 关状态指令
switchData.setOnCommand(commandList.get(1));  // 开状态指令
```

4. **指令发送**：
```java
String commandToSend = switchData.getNextCommand();
// 当前状态为关时，发送开指令
// 当前状态为开时，发送关指令
```

---

## 🎯 预期修复效果

### 修复后的预期日志：

#### 指令数据加载：
```
从commands加载指令:
关状态指令: 开启指令|TCP|127.0.0.1|8080|00 01 00 00 00 06 01 06 00 01 00 01
开状态指令: 关闭指令|TCP|127.0.0.1|8080|00 01 00 00 00 06 01 06 00 01 00 00
```

#### 指令发送：
```
执行开关按钮
当前状态: 关
发送指令: 开启指令|TCP|127.0.0.1|8080|00 01 00 00 00 06 01 06 00 01 00 01
→ 发送指令: 开启指令 [TCP 127.0.0.1:8080] 数据长度: 12 字节
  十六进制数据: 00 01 00 00 00 06 01 06 00 01 00 01
  ✓ TCP数据发送完成，已发送 12 字节
```

#### UI更新：
```
调试：当前状态=true, 应显示图片=USERDATA/appearance/button/button1/btn2.png
调试：实例中组件数量=1
调试：找到JLabel组件，当前图标=有图标
✓ 开关按钮图片已更新: USERDATA/appearance/button/button1/btn2.png
✓ 开关按钮状态已切换为: 开
```

---

## ✅ 验证步骤

1. **重新启动程序**
2. **点击开关按钮**
3. **检查控制台输出**：
   - 确认指令数据正确加载
   - 确认发送的是完整的十六进制数据
   - 确认UI更新调试信息
4. **检查界面变化**：
   - 按钮样式应该从 btn1.png 切换到 btn2.png

---

## 🔍 故障排除

如果问题仍然存在：

1. **检查文件路径**：确认 btn1.png 和 btn2.png 文件存在
2. **检查权限**：确认程序有读取图片文件的权限
3. **检查数据格式**：确认 project_data.json 中的数据格式正确
4. **查看完整日志**：关注所有调试输出信息

修复完成后，开关按钮应该能够：
- ✅ 发送完整的十六进制指令数据
- ✅ 正确切换按钮样式（btn1.png ↔ btn2.png）
- ✅ 提供详细的调试信息
